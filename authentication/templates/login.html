<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EiBraille</title>
    <link rel="shortcut icon" type="x-icon" href="https://firebasestorage.googleapis.com/v0/b/brailleproject-8091a.appspot.com/o/Frontend%2FTime%2FDOG.png?alt=media&token=81baa2e3-03ba-414c-b731-f8dbe1c04ee3">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
</head>
<body>
    <div id="background-music-container" style="display: none;">
        <iframe id="background-music" width="0" height="0" src="https://www.youtube.com/embed/{{ YOUTUBE_VIDEO_ID }}?autoplay=1&loop=1&playlist={{ YOUTUBE_VIDEO_ID }}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
    <button id="mute-button" style="position: fixed; bottom: 10px; right: 10px; z-index: 1000;">Mute</button>
    
    <div id="cameraSection" style="display: flex; justify-content: center;">
        <video id="webcam" autoplay></video>
        <div id="countdown" style="font-size: 2rem; color: white; position: absolute; top: 10px;"></div>
    </div>
    <button style="display: none;" id="startButton" onclick="startRecording()">Start Recording</button>

    <form id="recognizeForm" style="display: none;" action="/recognize" method="POST" enctype="multipart/form-data">
        <input style="display: none;" type="file" name="audio" id="audioInput">
        <button style="display: none;" type="submit">Submit Audio</button>
    </form>
</body>

<style>
    body {
        background-image: url('EbrailleAssets/uploads/Background2.png');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow-x: hidden;
        display: flex; 
        justify-content: center; 
        align-items: center;
        flex-direction: column;
    }
    #webcam {
        width: 90vw; /* Adjust the width to fit the screen */
        max-width: 1280px; /* Maximum width */
        aspect-ratio: 16 / 9; /* Maintain 16:9 aspect ratio */
        border-radius: 20px;
        background-color: white;
        object-fit: cover;
    }
    #userForm, #cameraSection {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #startButton {
        padding: 10px 20px;
        font-size: 16px;
        margin-top: 10px;
        cursor: pointer;
    }
    #countdown {
        font-size: 3rem;
        color: white;
        position: absolute;
        top: 10px;
    }
</style>

<script>
    startWebcam();

    const firebaseConfig = {
        apiKey: "AIzaSyDhoW3-RxzTczI9FqV0Fg5lafKty0g0_DE",
        authDomain: "brailleproject-8091a.firebaseapp.com",
        databaseURL: "https://brailleproject-8091a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "brailleproject-8091a",
        storageBucket: "brailleproject-8091a.appspot.com",
        messagingSenderId: "1000098958215",
        appId: "1:1000098958215:web:19e7f4e31ddda933d6a122",
        measurementId: "G-2FTL8V7H0B"
    };

    firebase.initializeApp(firebaseConfig);

    firebase.auth().signInAnonymously().catch((error) => {
        console.error('Error signing in anonymously:', error);
    });

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            console.log('User is signed in:', user);
        } else {
            console.log('No user is signed in.');
        }
    });
    let isMuted = false;

    document.addEventListener("DOMContentLoaded", function() {
        var iframe = document.getElementById("background-music");
        var muteButton = document.getElementById("mute-button");

        iframe.src = iframe.src;

        muteButton.addEventListener("click", function() {
            if (isMuted) {
                // Unmute the video
                iframe.src = `https://www.youtube.com/embed/{{ YOUTUBE_VIDEO_ID }}?autoplay=1&loop=1&playlist={{ YOUTUBE_VIDEO_ID }}`;
                muteButton.textContent = 'Mute';
            } else {
                // Mute the video
                iframe.src = `https://www.youtube.com/embed/{{ YOUTUBE_VIDEO_ID }}?autoplay=1&loop=1&playlist={{ YOUTUBE_VIDEO_ID }}&mute=1`;
                muteButton.textContent = 'Unmute';
            }
            isMuted = !isMuted;
        });
    });


    async function startWebcam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const videoElement = document.getElementById('webcam');
            videoElement.srcObject = stream;

            let countdown = 5;
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = countdown;
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                if (countdown === 0) {
                    clearInterval(countdownInterval);
                    captureImage();
                }
            }, 1000);
        } catch (error) {
            console.error('Error accessing webcam:', error);
        }
    }

    async function captureImage() {
        const canvas = document.createElement('canvas');
        const videoElement = document.getElementById('webcam');
        const countdownElement = document.getElementById('countdown');
        countdownElement.style.display = 'none';
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

        const dataURL = canvas.toDataURL('image/png');
        console.log('Captured Image:', dataURL);

        videoElement.srcObject.getTracks().forEach(track => track.stop());

        Swal.fire({
            title: 'Is this image okay?',
            imageUrl: dataURL,
            imageAlt: 'Captured Image',
            showCancelButton: true,
            confirmButtonText: 'Yes',
            cancelButtonText: 'No',
        }).then((result) => {
            if (result.isConfirmed) {
                uploadImageToFirebase(dataURL);
                saveImageLocally(dataURL);
            } else {
                startWebcam();
            }
        });
    }

    async function uploadImageToFirebase(dataURL) {
        try {
            const storageRef = firebase.storage().ref();
            const imageRef = storageRef.child(`Authen2/${Date.now()}.png`);
            const snapshot = await imageRef.putString(dataURL, 'data_url');
            console.log('Uploaded a base64 string!', snapshot);
            const downloadURL = await snapshot.ref.getDownloadURL();
            console.log('File available at', downloadURL);
            recordAudio();
        } catch (error) {
            console.error('Error uploading image:', error);
            Swal.fire({
                icon: 'error',
                title: 'Upload failed',
                text: 'Error uploading image: ' + error.message
            });
        }
    }

    async function saveImageLocally(dataURL) {
        try {
            const response = await fetch('saveImage/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dataURL: dataURL })
            });
            if (response.ok) {
                const result = await response.json();
                console.log('Image saved locally:', result);
                const filepath = result.path.replace(/\\/g, '/');  // Convert backslashes to forward slashes
                facedetect(filepath);
            } else {
                console.error('Error saving image locally:', response.statusText);
            }
        } catch (error) {
            console.error('Error saving image locally:', error);
        }
    }
    function redirectToHome() {
        setTimeout(function() {
            window.location.href = '../home/';
        }, 1000);
    }

    function recordAudio() {
        Swal.fire({
            title: 'Please say "สวัสดี eibraille" three times',
            confirmButtonText: 'Start Recording'
        }).then((result) => {
            if (result.isConfirmed) {
                startRecording();
            }
        });
    }

    function startRecording() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                const mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioURL = URL.createObjectURL(audioBlob);
                    const audioRef = firebase.storage().ref().child(`Authen2/audio-${Date.now()}.wav`);
                    await audioRef.put(audioBlob);
                    const audioDownloadURL = await audioRef.getDownloadURL();
                    console.log('Audio file available at', audioDownloadURL);
                    Swal.fire({
                        icon: 'success',
                        title: 'Audio uploaded successfully',
                        text: 'Now you can log in.'
                    });
                    saveAudioLocally(audioBlob);
                };
                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), 5000);
            })
            .catch(error => {
                console.error('Error accessing audio devices:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Recording failed',
                    text: 'Error accessing audio devices: ' + error.message
                });
            });
    }
    document.addEventListener('keydown', (event) => {
            if (event.key === 'A' || event.key === 'a') {
                window.location.href = '../home/';
            } else if (event.key === 'P' || event.key === 'p') {
                window.location.href = '../home/';
            }
        });
    async function saveAudioLocally(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, `audio-${Date.now()}.wav`);

        fetch('recognize/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Audio saved locally:', data);
            Swal.fire({
                icon: 'success',
                title: 'Recognition completed',
                text: 'Result: ' + data.message
            });
        })
        .catch(error => {
            console.error('Error saving audio locally:', error);
            Swal.fire({
                icon: 'error',
                title: 'Recognition failed',
                text: 'Error recognizing audio: ' + error.message
            });
        });
    }
    document.addEventListener("DOMContentLoaded", function() {
            var audio = document.getElementById("background-music");
            audio.play();

            if (typeof(Storage) !== "undefined") {
                if (!sessionStorage.getItem("musicStarted")) {
                    audio.play();
                    sessionStorage.setItem("musicStarted", "true");
                }
            } else {
                audio.play();
            }
        });
    async function facedetect(path) {
        try {
            const response = await fetch('process_photo/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filepath: path })
            });
            if (response.ok) {
                const result = await response.json();
                console.log('Successfully posted face detect:', result);
            } else {
                console.error('Error posting to face detect:', response.statusText);
            }
        } catch (error) {
            console.error('Error posting to face detect service endpoint:', error);
        }
        
    }
    
</script>
</html>
