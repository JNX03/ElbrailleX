<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EiBraille</title>
    <link rel="shortcut icon" type="x-icon" href="https://firebasestorage.googleapis.com/v0/b/brailleproject-8091a.appspot.com/o/Frontend%2FTime%2FDOG.png?alt=media&token=81baa2e3-03ba-414c-b731-f8dbe1c04ee3">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-storage.js"></script>
</head>
<body>
    <div id="background-music-container" style="display: none;">
        <iframe id="background-music" width="0" height="0" src="https://www.youtube.com/embed/{{ YOUTUBE_VIDEO_ID }}?autoplay=1&loop=1&playlist={{ YOUTUBE_VIDEO_ID }}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
    </div>
    <button id="mute-button" style="position: fixed; bottom: 100px; right: 100px; z-index: 1000;">Mute</button>
        <div id="userForm">
        <input type="text" id="username" placeholder="Enter your username" required>
        <button id="startButton">Start</button>
    </div>
    <div id="cameraSection" style="display: none;">
        <video id="webcam" autoplay></video>
        <div id="countdown" style="font-size: 2rem; color: white; position: absolute; top: 10px;"></div>
        <canvas id="canvas" style="display: none;"></canvas>
    </div>
    <audio id="audioPlayback" controls style="display:none;"></audio>
</body>

<style>
    body {
        background-image: url('https://firebasestorage.googleapis.com/v0/b/eibraillex-81280.appspot.com/o/Asset%2FSlide%2016_9%20-%2082.png?alt=media&token=6a1e4f37-389e-4a6c-96df-314bdcf4c96f');
        background-size: cover;
        background-repeat: no-repeat;
        background-position: center;
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow-x: hidden;
        display: flex; 
        justify-content: center; 
        align-items: center;
        flex-direction: column;
    }
    #webcam {
        width: 90vw;
        max-width: 1280px;
        aspect-ratio: 16 / 9;
        border-radius: 20px;
        background-color: white;
        object-fit: cover;
    }
    #userForm, #cameraSection {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #username {
        padding: 10px;
        font-size: 16px;
        margin-bottom: 10px;
    }
    #startButton {
        padding: 10px 20px;
        font-size: 16px;
        margin-top: 10px;
        cursor: pointer;
    }
    #countdown {
        font-size: 3rem;
        color: white;
        position: absolute;
        top: 10px;
    }
</style>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDhoW3-RxzTczI9FqV0Fg5lafKty0g0_DE",
        authDomain: "brailleproject-8091a.firebaseapp.com",
        databaseURL: "https://brailleproject-8091a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "brailleproject-8091a",
        storageBucket: "brailleproject-8091a.appspot.com",
        messagingSenderId: "1000098958215",
        appId: "1:1000098958215:web:19e7f4e31ddda933d6a122",
        measurementId: "G-2FTL8V7H0B"
    };

    firebase.initializeApp(firebaseConfig);

    firebase.auth().signInAnonymously().catch((error) => {
        console.error('Error signing in anonymously:', error);
    });

    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            console.log('User is signed in:', user);
        } else {
            console.log('No user is signed in.');
        }
    });

    let isMuted = false;

document.addEventListener("DOMContentLoaded", function() {
    var iframe = document.getElementById("background-music");
    var muteButton = document.getElementById("mute-button");

    iframe.src = iframe.src;

    muteButton.addEventListener("click", function() {
        if (isMuted) {
            // Unmute the video
            iframe.src = `https://www.youtube.com/embed/{{ YOUTUBE_VIDEO_ID }}?autoplay=1&loop=1&playlist={{ YOUTUBE_VIDEO_ID }}`;
            muteButton.textContent = 'Mute';
        } else {
            // Mute the video
            iframe.src = `https://www.youtube.com/embed/{{ YOUTUBE_VIDEO_ID }}?autoplay=1&loop=1&playlist={{ YOUTUBE_VIDEO_ID }}&mute=1`;
            muteButton.textContent = 'Unmute';
        }
        isMuted = !isMuted;
    });
});
document.addEventListener('keydown', (event) => {
            if (event.key === 'A' || event.key === 'a') {
                window.location.href = '../home/';
            } else if (event.key === 'P' || event.key === 'p') {
                window.location.href = '../home/';
            }
        });
    document.getElementById('startButton').addEventListener('click', function() {
        const username = document.getElementById('username').value;
        if (username) {
            document.getElementById('userForm').style.display = 'none';
            document.getElementById('cameraSection').style.display = 'flex';
            startWebcam();
        } else {
            alert('Please enter your username.');
        }
    });

    async function startWebcam() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const videoElement = document.getElementById('webcam');
            videoElement.srcObject = stream;

            let countdown = 5;
            const countdownElement = document.getElementById('countdown');
            countdownElement.textContent = countdown;
            const countdownInterval = setInterval(() => {
                countdown--;
                countdownElement.textContent = countdown;
                if (countdown === 0) {
                    clearInterval(countdownInterval);
                    captureImages(3);
                }
            }, 1000);
        } catch (error) {
            console.error('Error accessing webcam:', error);
        }
    }

    async function captureImages(numberOfPhotos) {
        const canvas = document.getElementById('canvas');
        const videoElement = document.getElementById('webcam');
        const countdownElement = document.getElementById('countdown');
        countdownElement.style.display = 'none';
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        const context = canvas.getContext('2d');
        const photos = [];

        for (let i = 0; i < numberOfPhotos; i++) {
            context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
            photos.push(canvas.toDataURL('image/png'));
            if (i < numberOfPhotos - 1) {
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
        }

        console.log('Captured Images:', photos);

        videoElement.srcObject.getTracks().forEach(track => track.stop());

        Swal.fire({
            title: 'Is this image okay?',
            imageUrl: photos[photos.length - 1],
            imageAlt: 'Captured Image',
            showCancelButton: true,
            confirmButtonText: 'Yes',
            cancelButtonText: 'No',
        }).then((result) => {
            if (result.isConfirmed) {
                uploadImagesToFirebase(photos);
            } else {
                startWebcam();
            }
        });
    }

    async function uploadImagesToFirebase(photos) {
        try {
            const username = document.getElementById('username').value;
            const storageRef = firebase.storage().ref();
            for (const photo of photos) {
                const imageRef = storageRef.child(`Authen2/${username}/Image/${Date.now()}.png`);
                const snapshot = await imageRef.putString(photo, 'data_url');
                console.log('Uploaded a base64 string!', snapshot);
                const downloadURL = await snapshot.ref.getDownloadURL();
                console.log('File available at', downloadURL);
            }
            recordAudio();
        } catch (error) {
            console.error('Error uploading images:', error);
            Swal.fire({
                icon: 'error',
                title: 'Upload failed',
                text: 'Error uploading images: ' + error.message
            });
        }
    }

    function recordAudio() {
        Swal.fire({
            title: 'Please say "สวัสดี eibraille" three times',
            confirmButtonText: 'Start Recording'
        }).then((result) => {
            if (result.isConfirmed) {
                startRecording();
            }
        });
    }

    function startRecording() {
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                const mediaRecorder = new MediaRecorder(stream);
                const audioChunks = [];
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const audioURL = URL.createObjectURL(audioBlob);

                    // Debugging: Play the audio locally
                    const audioPlayback = document.getElementById('audioPlayback');
                    audioPlayback.src = audioURL;
                    audioPlayback.style.display = 'block';
                    audioPlayback.play();

                    const audioRef = firebase.storage().ref().child(`Authen2/${document.getElementById('username').value}/${document.getElementById('username').value}-audio.wav`);
                    await audioRef.put(audioBlob);
                    const audioDownloadURL = await audioRef.getDownloadURL();
                    console.log('Audio file available at', audioDownloadURL);
                    Swal.fire({
                        icon: 'success',
                        title: 'Audio uploaded successfully',
                        text: 'Now you can log in.'
                    });
                    saveAudioLocally(audioBlob, document.getElementById('username').value);
                    postToTrainEndpoint(document.getElementById('username').value);
                };
                mediaRecorder.start();
                setTimeout(() => mediaRecorder.stop(), 5000);
            })
            .catch(error => {
                console.error('Error accessing audio devices:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Recording failed',
                    text: 'Error accessing audio devices: ' + error.message
                });
            });
    }

    async function saveAudioLocally(audioBlob, username) {
        const formData = new FormData();
        formData.append('audio', audioBlob, `${username}-audio.wav`);
        formData.append('username', username);

        fetch('/saveAudio/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Audio saved locally:', data);
        })
        .catch(error => {
            console.error('Error saving audio locally:', error);
        });
    }

    async function postToTrainEndpoint(username) {
        try {
            const response = await fetch(`/train?username=${username}`, {
                method: 'POST',
            });
            if (response.ok) {
                console.log('Successfully posted to train endpoint');
                redirectToHome();
            } else {
                console.error('Error posting to train endpoint:', response.statusText);
            }
        } catch (error) {
            console.error('Error posting to train endpoint:', error);
        }
    }

    function redirectToHome() {
        setTimeout(function() {
            window.location.href = '../home/';
        }, 1000);
    }
</script>
</html>
